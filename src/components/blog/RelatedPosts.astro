---
import Picture from '~/components/core/Picture.astro';

import { findPostsByIds } from '~/utils/posts';
import { findImage } from '~/utils/images';
import { getPermalink, cleanSlug, POST_BASE } from '~/utils/permalinks';

import Item from '~/components/blog/ListItem.astro';
import { fetchPosts } from '~/utils/posts';

// The component accepts two configurable options:
// 1. maxTags: Controls how many tags from the current post to use when finding related posts (default is 2)
// 2. maxTagsItems: Controls how many posts to show per tag (default is 3)

const { currentPost, maxTags = 2, maxTagsItems = 2 } = Astro.props;

// Get all posts
const allPosts = await fetchPosts();

// Extract tags from current post
const currentPostTags = currentPost.tags || [];

// Get first N tags (limited by maxTags)
const tagsToUse = currentPostTags.slice(0, maxTags);

// Count related posts for each tag
const tagCounts = [];

for (const tag of currentPostTags) {
  const count = allPosts.filter(post => 
    post.slug !== currentPost.slug && // Exclude current post
    post.tags && 
    post.tags.includes(tag)
  ).length;
  
  if (count > 0) {
    tagCounts.push({ tag, count });
  }
}

// Sort tags by count (descending) and take top maxTags
const topTags = tagCounts
  .sort((a, b) => b.count - a.count)
  .slice(0, maxTags)
  .map(item => item.tag);

// Find related posts using the most productive tags
const relatedPostsMap = new Map();

topTags.forEach(tag => {
  const taggedPosts = allPosts.filter(post => 
    post.slug !== currentPost.slug && // Exclude current post
    post.tags && 
    post.tags.includes(tag)
  ).slice(0, maxTagsItems); // Limit by maxTagsItems
  
  taggedPosts.forEach(post => {
    if (!relatedPostsMap.has(post.slug)) {
      relatedPostsMap.set(post.slug, post);
    }
  });
});

// Process images for related posts
const processedRelatedPosts = await Promise.all(
  Array.from(relatedPostsMap.values())
    .slice(0, maxTags * maxTagsItems)
    .map(async (post) => ({ ...post, image: await findImage(post.image) }))
);
---

{
  processedRelatedPosts.length > 0 && (

    <section class="px-4 py-16 mx-auto max-w-6xl lg:py-20" id="blogposts">
        <div class="flex flex-col mb-6 lg:justify-between lg:flex-row md:mb-8">
            <h2 class="max-w-lg mb-2 text-3xl font-bold tracking-tight sm:text-4xl sm:leading-none lg:mb-5 group font-heading">
                <span class="inline-block mb-1 sm:mb-4">Related Articles</span>
            </h2>

            <p class="text-gray-700 dark:text-slate-400 lg:text-sm lg:max-w-md">
                Practical guides to set up, and run a local development environment with honest reviews and documentation that actually work.
            </p>
        </div>

        <div class="grid gap-6 row-gap-5 md:grid-cols-2 lg:grid-cols-4 -mb-6">
            {
                processedRelatedPosts.map((post) => (
                    <article class="mb-6 transition">
                        <Picture
                            src={post.image}
                            class="object-cover w-full h-64 mb-6 rounded shadow-lg bg-gray-400 dark:bg-slate-700"
                            widths={[400, 900]}
                            sizes="(max-width: 900px) 400px, 900px"
                            alt={post.title}
                            aspectRatio="16:9"
                        />
                        <h3 class="mb-2 text-xl font-bold leading-snug sm:text-2xl font-heading">
                            <a
                                href={getPermalink(post.slug, 'post')}
                                class="hover:text-primary-600 underline underline-offset-4 decoration-1 decoration-dotted transition ease-in duration-200"
                            >
                                {post.title}
                            </a>
                        </h3>
                        <p class="text-gray-700 dark:text-gray-400">{post.excerpt || post.description}</p>
                    </article>
                ))
            }
        </div>
    </section>

  )
}